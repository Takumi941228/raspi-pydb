# Raspberry Piを活用したデータ処理とグラフ表示によるIoTシステム構築

## 課題

これまでの実習で、「ESP32とBME280で取得した温度・湿度・気圧をMQTT経由で送信する」または「RaspberryPiとBME280で取得した温度・湿度・気圧をMQTT経由で送信する」ことができました。また、「MQTTブローカからのデータをデータベースに追加する」及び「蓄積されたデータをグラフによる可視化する」ことができました。

これまでに製作したプログラムを組み合わせて、以下の要素からなるシステムを製作してください。

### ハードウェアの課題

* 基板加工機と電子回路CADを用いて、ESP32が搭載された自作IoT基板を製作する。（回路は「6. MQTT経由のデータの取得と蓄積」を参照）

* ESP32に接続したBME280のデータをMQTTブローカへ送信するため、無線LAN環境を各自、構築する。
    * 設定項目

        |SSID|PASSWORD|
        |---|---|
        |403-自分の名前(例:403-hirota)|Passw0rd|

    * ESP32のIPアドレスは、DHCPサーバによる自動配布にすること。
    * LAN内ネットワーク（IPアドレスやセグメント等）は、問わない。
    * ESP32は、2.4GHz帯のみ対応なので、注意すること。
    * ルータのWAN側は、各テーブルに取り付き済みのHUBに挿すこと。
        * WAN側IP:192.168.1xx.yy（空いているIPならどれでもよい）
    * ESP32とMQTTブローカが相互通信できるようにする。
    * 使用機器は、以下に示す。

        |機器名|型番|
        |---|---|
        |ルータ|Cisco 1812J or Cisco 1921|
        |アクセスポイント|Cisco AIR-AP114IN(または同等品)|
        |L3スイッチ|Cisco 3560|
        |LANケーブル|-|

### ソフトウェアの課題

* ESP32のプログラムを変更する。
    * LCDの表示内容の変更（常に１行目に現在時間を表示）（２行目に温度か湿度か気圧「タクトスイッチによる切り替え」を表示）

        |行数|操作|内容|
        |---|---|---|
        |１行目|常に（SW押下中は、消えても良い）|時:分:秒|
        |２行目|黄SW押下|T:●●.●●|
        |２行目|緑SW押下|P:●●.●●|
        |２行目|赤SW押下|H:●●●●|

        * 黄SW押下、黄LEDが点灯、LCDに温度値を小数点第二位まで表示（例:「T:23.82」）
        * 緑SW押下、緑LEDが点灯、LCDに気圧値を整数のみ表示（例:「P:1013」100で割ったものをint型にキャスト変換する良い）
        * 赤SW押下、赤LEDが点灯、LCDに湿度値を小数点第二位まで表示（例:「H:29.76」）

    * 自分のRaspberryPiをMQTTブローカとして、ESP32に接続されたBME280で取得した温度・湿度・気圧と時間をTickerライブラリによるタイマ割り込みを用いて１０秒毎にMQTT経由で常に送信し続ける。
        * MQTTブローカアドレス:192.168.1xx.200
        * topic名:esp32/bme280
        * device名:esp32-1

* 課題用の新しいデータベースを作成する。
    * ユーザ名:sangi_自分の名前（例:sangi_hirota）
    * パスワード:Passw0rd
    * データベース名:sangi_storage
    * テーブル名:Environment
    * カラム内容は以下の表に示す。

    | 内容 | カラム名 | データ型 | 制約 |
    | --- | --- | --- | --- |
    | 主キー | row_id | INT | PRIMARY KEY NOT NULL AUTO_INCREMENT |
    | 取得した日付と時刻 | timestamp | TIMESTAMP | - |
    | 取得したノードの識別子 | identifier | CHAR(24) | - |
    | 温度 | temperature | DOUBLE | - |
    | 湿度 | humidity | DOUBLE | - |
    | 気圧 | pressure | DOUBLE | - |

* 自分のRaspberryPiのMQTTブローカからのESP32のデータを受信し、識別ノードID及び受信した日付を付与して、新しく作成したデータベースに蓄積する。また、作成したPythonスクリプトは、継続的に蓄積させるため、常に実行し続けること。（「5. データの継続的な取得と蓄積」を参考）
    * 識別ノードID:sangi_mqtt_esp32

* 自分のRaspberryPiに接続されたBME280のデータを１０秒毎に、自分のRaspberryPiのMQTTブローカに送信する。
* 同じく自分のRaspberryPiのMQTTブローカから受信したデータを同様に作成したデータベースに蓄積する。また、作成したPythonスクリプトは、継続的に蓄積させるため、常に実行し続けること。（「9. MQTTブローカを経由した測定データの蓄積」を参考）
    * 識別ノードID:sangi_mqtt_raspi
    * topic名:raspi/bme280

* 蓄積したデータを使って、キー入力によるサンプル数及び更新周期の設定後、温度・湿度・気圧の３つのグラフをリアルタイムに表示する。（「8. グラフによるデータの可視化」を参考）
    * パターン１
        * １行３列の形式で、温度・湿度・気圧の順で表示するようにする。
        * 以下のターミナルのように識別ノードIDをキー入力による選択で、グラフに表示するデータがESP32またはRaspberryPiに接続されたBME280のデータを切り替えれること。

        ```bash
        最新のデータをリアルタイムに表示します。
        どのノードのデータを表示しますか？
        ノードの Identifier(例: sangi_mqtt_esp32): sangi_mqtt_raspi
        何サンプル前のデータまで表示しますか？
        数値を入力(例: 20) : 20
        グラフの更新周期(秒)は？
        数値を入力(例: 10) : 10
        ```

    * パターン２
        * ESP32及びRaspberryPiに接続されたBME280のデータを２行３列の形式で、それぞれ温度・湿度・気圧の順で表示するようにする。

        ```bash
        最新のデータをリアルタイムに表示します。
        何サンプル前のデータまで表示しますか？
        数値を入力(例: 20) : 20
        グラフの更新周期(秒)は？
        数値を入力(例: 10) : 10
        ```
